<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Project Mnemosyne</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* --- CORE THEME --- */
        :root { --bg: #050505; --text: #00ff41; --fail: #ff003c; --ui: #1a1a1a; --font: 'VT323', monospace; }
        
        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: var(--font); 
            margin: 0; 
            overflow: hidden; 
            height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 20px; /* Base size */
        }

        /* --- RESPONSIVE CONTAINER (Mobile vs Laptop) --- */
        #app-container {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            background: #000;
            overflow: hidden;
        }

        /* Laptop/Tablet Mode: Center the game like a phone */
        @media (min-width: 768px) {
            #app-container {
                max-width: 450px;
                max-height: 90vh;
                border: 2px solid var(--ui);
                box-shadow: 0 0 50px rgba(0, 255, 65, 0.1);
                border-radius: 20px;
            }
            body { background: #111; } /* Darker background for laptop outside game */
        }

        /* --- CRT OVERLAY (High Graphics Only) --- */
        #crt-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%; pointer-events: none; z-index: 999;
        }
        /* Low Graphics Mode: Hide CRT */
        body.low-gfx #crt-overlay { display: none; }
        body.low-gfx * { text-shadow: none !important; box-shadow: none !important; }

        /* --- SCREENS --- */
        .screen { display: none; flex: 1; flex-direction: column; padding: 20px; box-sizing: border-box; width: 100%; }
        .active { display: flex; }
        .center { justify-content: center; align-items: center; text-align: center; }

        /* --- UI ELEMENTS --- */
        h1 { text-shadow: 0 0 10px var(--text); font-size: 32px; letter-spacing: 2px; margin: 10px 0; }
        
        .btn {
            background: rgba(0, 255, 65, 0.05); border: 1px solid var(--text); color: var(--text);
            padding: 12px; margin: 8px 0; width: 100%; font-family: inherit; font-size: 22px; cursor: pointer;
            text-transform: uppercase; display: flex; justify-content: space-between; align-items: center;
        }
        .btn:hover { background: var(--text); color: black; }
        
        /* TEXT FIX: Ensures text stays on screen and wraps correctly */
        .dialogue-box { 
            background: rgba(0,20,0,0.95); border: 1px solid var(--text); padding: 20px; 
            margin-top: auto; min-height: 180px; 
            font-size: 24px; line-height: 1.4; 
            box-shadow: 0 0 15px rgba(0,255,65,0.2); 
            cursor: pointer;
            white-space: pre-wrap; /* Preserves spaces but wraps text */
            word-wrap: break-word; /* Prevents long words breaking layout */
            overflow-y: auto;
        }

        /* --- SETTINGS UI --- */
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 22px; }
        select, input[type=range] { background: #000; color: var(--text); border: 1px solid var(--text); font-family: inherit; font-size: 18px; padding: 5px; }
        
        /* --- GAMEPLAY --- */
        #game-area { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 300px; }
        .tile { height: 90px; border-radius: 5px; border: 2px solid #333; }
        
    </style>
</head>
<body>

    <div id="app-container">
        <div id="crt-overlay"></div>

        <div id="screen-menu" class="screen center active">
            <h1>MNEMOSYNE</h1>
            <p id="menu-status">SYSTEM STATUS: CRITICAL</p>
            <br>
            <button class="btn center" onclick="startGame()"><span data-t="start">START GAME</span></button>
            <button class="btn center" onclick="showSettings()"><span data-t="settings">SETTINGS</span></button>
        </div>

        <div id="screen-settings" class="screen">
            <h2 data-t="settings">SETTINGS</h2>
            
            <div class="setting-row">
                <span data-t="lang">Language</span>
                <select id="set-lang" onchange="changeLanguage(this.value)">
                    <option value="en">English</option>
                    <option value="ru">Russian</option>
                    <option value="gu">Gujarati</option>
                    <option value="jp">Japanese</option>
                </select>
            </div>

            <div class="setting-row">
                <span data-t="graphics">Graphics</span>
                <select id="set-gfx" onchange="changeGraphics(this.value)">
                    <option value="high">High (CRT)</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low (Fast)</option>
                </select>
            </div>

            <div class="setting-row">
                <span data-t="audio">Audio Vol</span>
                <span id="vol-display">10</span>
            </div>
            <input type="range" min="0" max="15" value="10" style="width: 100%;" oninput="changeVolume(this.value)">

            <div class="setting-row" style="margin-top: 20px;">
                <span data-t="scale">UI Scale</span>
                <select onchange="changeScale(this.value)">
                    <option value="0.8">Small</option>
                    <option value="1.0" selected>Normal</option>
                    <option value="1.2">Large</option>
                </select>
            </div>

            <div style="flex:1"></div>
            <button class="btn center" onclick="showScreen('screen-menu')"><span data-t="back">BACK</span></button>
        </div>

        <div id="screen-story" class="screen" onclick="advanceStory()">
            <div style="flex:1;"></div>
            <div class="dialogue-box">
                <b id="speaker-name" style="color: #fff;">SYSTEM:</b><br><br>
                <span id="story-text"></span>
                <div style="text-align: right; font-size: 16px; margin-top: 15px; opacity: 0.7;" class="blink">[TAP]</div>
            </div>
        </div>

        <div id="screen-game" class="screen">
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #333; padding-bottom:5px;">
                <span id="ui-timer">0.0s</span>
                <span id="ui-req">0</span>
            </div>
            <div id="game-area">
                <div id="prompt-display" style="font-size: 40px; margin-bottom: 20px;">READY</div>
                <div id="options-container" class="grid-2"></div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- TRANSLATION DATA ---
        const LANG_DATA = {
            en: { start: "INITIALIZE", settings: "SETTINGS", lang: "LANGUAGE", graphics: "GRAPHICS", audio: "AUDIO", scale: "UI SCALE", back: "BACK" },
            ru: { start: "НАЧАТЬ", settings: "НАСТРОЙКИ", lang: "ЯЗЫК", graphics: "ГРАФИКА", audio: "ЗВУК", scale: "МАСШТАБ", back: "НАЗАД" },
            hi: { start: "начать", settings: "настройки", lang: "भाषा", graphics: "ग्राफिक्स", audio: "आवाज़", scale: "स्केल", back: "वापस" },
            gu: { start: "શરૂઆત", settings: "સેટિંગ્સ", lang: "ભાષા", graphics: "ગ્રાફિક્સ", audio: "અવાજ", scale: "માપ", back: "પાછા" },
            jp: { start: "開始", settings: "設定", lang: "言語", graphics: "グラフィックス", audio: "オーディオ", scale: "規模", back: "戻る" }
        };

        // --- SETTINGS STATE ---
        let settings = { lang: 'en', gfx: 'high', vol: 10, scale: 1.0 };
        
        function loadSettings() {
            const saved = localStorage.getItem('mnemosyne_settings');
            if(saved) settings = JSON.parse(saved);
            
            // Apply loaded settings
            document.getElementById('set-lang').value = settings.lang;
            document.getElementById('set-gfx').value = settings.gfx;
            changeGraphics(settings.gfx);
            updateLangUI();
        }

        function saveSettings() {
            localStorage.setItem('mnemosyne_settings', JSON.stringify(settings));
        }

        // --- SETTINGS LOGIC ---
        function showSettings() { showScreen('screen-settings'); }
        
        function changeLanguage(code) {
            settings.lang = code;
            saveSettings();
            updateLangUI();
        }
        
        function updateLangUI() {
            document.querySelectorAll('[data-t]').forEach(el => {
                const key = el.getAttribute('data-t');
                if(LANG_DATA[settings.lang][key]) {
                    el.innerText = LANG_DATA[settings.lang][key];
                }
            });
        }

        function changeGraphics(mode) {
            settings.gfx = mode;
            saveSettings();
            document.body.className = (mode === 'low') ? 'low-gfx' : '';
            if(mode === 'medium') document.getElementById('crt-overlay').style.opacity = '0.3';
            else document.getElementById('crt-overlay').style.opacity = '1';
        }

        function changeVolume(val) {
            settings.vol = val;
            document.getElementById('vol-display').innerText = val;
            saveSettings();
        }

        function changeScale(val) {
            document.body.style.fontSize = (20 * val) + 'px';
        }

        // --- GAME LOGIC (Restored from previous version) ---
        const STORY_DATA = [
            { id: 1, type: "story", speaker: "SYSTEM", text: ["Connection established...", "Subject Zero vitals: Critical.", "Memory banks corrupted."] },
            { id: 2, type: "puzzle", mode: "match", speed: 2000, rounds: 3 },
            { id: 3, type: "story", speaker: "ZERO", text: ["I remember... a blue sky.", "But the sky hasn't been blue for years.", "Why am I remembering a lie?"] }
        ];

        let state = { level: 0 };
        let currentStoryText = [];
        let storyIndex = 0;

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function startGame() { state.level = 0; loadLevel(); }

        function loadLevel() {
            if(state.level >= STORY_DATA.length) { alert("DEMO COMPLETE"); return; }
            const data = STORY_DATA[state.level];
            
            if(data.type === 'story') {
                currentStoryText = data.text;
                storyIndex = 0;
                document.getElementById('speaker-name').innerText = data.speaker + ":";
                showScreen('screen-story');
                typeText(currentStoryText[0]);
            } else {
                startPuzzle(data);
            }
        }

        // FIXED TYPEWRITER EFFECT
        function typeText(txt) {
            const el = document.getElementById('story-text');
            el.innerHTML = ""; // Clear
            let i = 0;
            // Faster typing (20ms) and ensuring spaces are preserved
            const timer = setInterval(() => {
                el.textContent += txt.charAt(i);
                i++;
                // Auto scroll to bottom
                document.querySelector('.dialogue-box').scrollTop = document.querySelector('.dialogue-box').scrollHeight;
                if(i >= txt.length) clearInterval(timer);
            }, 20);
        }

        function advanceStory() {
            storyIndex++;
            if(storyIndex >= currentStoryText.length) {
                state.level++;
                loadLevel();
            } else {
                typeText(currentStoryText[storyIndex]);
            }
        }

        // --- BASIC PUZZLE LOGIC ---
        let pState = { score: 0, target: 0 };
        const COLORS = ['#ff003c', '#00ff41', '#00eaff', '#ffe600'];

        function startPuzzle(data) {
            pState.score = 0;
            pState.target = data.rounds;
            showScreen('screen-game');
            nextRound();
        }

        function nextRound() {
            if(pState.score >= pState.target) { state.level++; loadLevel(); return; }
            
            const target = COLORS[Math.floor(Math.random() * COLORS.length)];
            const prompt = document.getElementById('prompt-display');
            prompt.innerText = "";
            prompt.style.background = target;
            prompt.style.width = "100px"; prompt.style.height = "100px"; prompt.style.borderRadius = "50%";
            
            const container = document.getElementById('options-container');
            container.innerHTML = "";
            
            let opts = [...COLORS].sort(() => Math.random() - 0.5);
            opts.forEach(c => {
                let btn = document.createElement('div');
                btn.className = 'tile';
                btn.style.background = c;
                btn.onclick = () => {
                    if(c === target) { pState.score++; nextRound(); }
                    else { tg.HapticFeedback.notificationOccurred('error'); }
                };
                container.appendChild(btn);
            });
        }

        // Init
        loadSettings();

    </script>
</body>
</html>
