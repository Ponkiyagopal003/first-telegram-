<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Project Mnemosyne</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* --- CORE THEME --- */
        :root { --bg: #050505; --text: #00ff41; --fail: #ff003c; --ui: #1a1a1a; --font: 'VT323', monospace; }
        body { background: var(--bg); color: var(--text); font-family: var(--font); margin: 0; overflow: hidden; height: 100vh; display: flex; justify-content: center; align-items: center; font-size: 22px; user-select: none; }

        /* --- CONTAINER --- */
        #app-container { width: 100%; height: 100%; position: relative; display: flex; flex-direction: column; background: #000; overflow: hidden; }
        @media (min-width: 768px) {
            #app-container { max-width: 450px; max-height: 90vh; border: 2px solid var(--ui); box-shadow: 0 0 50px rgba(0, 255, 65, 0.1); border-radius: 20px; }
            body { background: #111; }
        }

        /* --- CRT EFFECT --- */
        #crt-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 2px, 3px 100%; pointer-events: none; z-index: 999; }

        /* --- UI ELEMENTS --- */
        .screen { display: none; flex: 1; flex-direction: column; width: 100%; height: 100%; }
        .active { display: flex; }
        .center { justify-content: center; align-items: center; text-align: center; }
        
        .btn { background: rgba(0, 255, 65, 0.05); border: 1px solid var(--text); color: var(--text); padding: 15px; margin: 10px; font-family: inherit; font-size: 24px; cursor: pointer; text-transform: uppercase; width: 80%; }
        .btn:active { background: var(--text); color: #000; }

        .dialogue-box { background: rgba(0,20,0,0.95); border-top: 2px solid var(--text); padding: 30px; margin-top: auto; min-height: 250px; font-size: 26px; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word; overflow-y: auto; }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }

        /* --- GAME: SIGNAL DECRYPT (Level 1 Mechanic) --- */
        #decrypt-area { width: 90%; height: 60px; border: 2px solid #333; position: relative; margin: 40px auto; background: #111; border-radius: 4px; overflow: hidden; }
        #target-zone { position: absolute; top: 0; height: 100%; background: rgba(0, 255, 65, 0.3); border-left: 2px solid var(--text); border-right: 2px solid var(--text); }
        #cursor-line { position: absolute; top: 0; width: 4px; height: 100%; background: #fff; box-shadow: 0 0 10px #fff; left: 0; }
        
        #progress-bar { width: 80%; height: 10px; background: #333; margin: 20px auto; }
        #progress-fill { height: 100%; background: var(--text); width: 0%; transition: width 0.2s; }
        
        .shake { animation: shake 0.4s; }
        @keyframes shake { 0% { transform: translate(1px, 1px) } 50% { transform: translate(-1px, -1px) } 100% { transform: translate(0, 0) } }

    </style>
</head>
<body>

    <div id="app-container">
        <div id="crt-overlay"></div>

        <div id="screen-menu" class="screen center active">
            <h1 style="font-size: 48px; margin: 0; text-shadow: 0 0 10px var(--text);">MNEMOSYNE</h1>
            <p style="opacity: 0.7;">REPAIRING NEURAL LINK...</p>
            <br>
            <button class="btn" onclick="startCampaign()">CONTINUE</button>
            <div style="font-size: 16px; margin-top: 20px;">LEVEL: <span id="lvl-display">1</span>/100</div>
        </div>

        <div id="screen-story" class="screen" onclick="advanceStory()">
            <div style="flex:1; display: flex; justify-content: center; align-items: center;">
                <div id="visual-context" style="font-size: 100px; color: #333;">üëÅÔ∏è</div>
            </div>
            <div class="dialogue-box">
                <b id="speaker-name">SYSTEM:</b><br><br>
                <span id="story-text"></span>
                <div class="blink" style="text-align: right; font-size: 18px; margin-top: 20px;">[TAP TO CONTINUE]</div>
            </div>
        </div>

        <div id="screen-decrypt" class="screen center">
            <h2 style="margin-bottom: 10px;">NEURAL SYNC</h2>
            <p style="font-size: 18px; opacity: 0.8;">TAP when the line is in the GREEN zone.</p>
            
            <div id="decrypt-area" onclick="checkDecryptHit()">
                <div id="target-zone" style="left: 40%; width: 20%;"></div>
                <div id="cursor-line"></div>
            </div>

            <div id="progress-bar"><div id="progress-fill"></div></div>
            <p id="decrypt-status">SYNC: 0%</p>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- THE 100 LEVEL DATABASE ---
        // To add Level 2, just copy the structure of Level 1 and change the ID and Text.
        const CAMPAIGN = [
            {
                id: 1,
                title: "Cold Boot",
                stages: [
                    // STAGE 1: INTRO STORY
                    {
                        type: "story",
                        speaker: "SYSTEM",
                        visual: "‚ö†Ô∏è",
                        text: ["boot_sequence_init...", "ERROR: Cortical Stack 99% Corrupted.", "Subject Zero not responding.", "Initiating emergency manual override."]
                    },
                    // STAGE 2: GAMEPLAY (EASY)
                    {
                        type: "game_decrypt",
                        difficulty: 1.0, // Speed multiplier
                        required: 3,     // Hits needed
                        msg: "ESTABLISHING CONNECTION..."
                    },
                    // STAGE 3: MID-STORY
                    {
                        type: "story",
                        speaker: "UNKNOWN VOICE",
                        visual: "üåë",
                        text: ["...can you hear me?", "It's so dark in here.", "I don't know who I am.", "Wait, I see a light."]
                    },
                    // STAGE 4: GAMEPLAY (HARD)
                    {
                        type: "game_decrypt",
                        difficulty: 1.5, // Faster
                        required: 5,     // More hits
                        msg: "STABILIZING MEMORY CORE..."
                    },
                    // STAGE 5: OUTRO
                    {
                        type: "story",
                        speaker: "SYSTEM",
                        visual: "‚úÖ",
                        text: ["Neural Link Established.", "Welcome back, Zero.", "We have a lot of work to do."]
                    }
                ]
            }
            // COPY HERE TO ADD LEVEL 2, 3, etc...
        ];

        // --- SAVE SYSTEM ---
        let saveData = { levelIndex: 0 };
        if(localStorage.getItem('mnemosyne_save')) {
            saveData = JSON.parse(localStorage.getItem('mnemosyne_save'));
        }
        document.getElementById('lvl-display').innerText = saveData.levelIndex + 1;

        // --- ENGINE STATE ---
        let currentStageIndex = 0;
        let currentLevelData = null;

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function startCampaign() {
            if(saveData.levelIndex >= CAMPAIGN.length) {
                alert("More levels coming soon!");
                return;
            }
            currentLevelData = CAMPAIGN[saveData.levelIndex];
            currentStageIndex = 0;
            loadStage();
        }

        function loadStage() {
            if(currentStageIndex >= currentLevelData.stages.length) {
                // Level Complete
                saveData.levelIndex++;
                localStorage.setItem('mnemosyne_save', JSON.stringify(saveData));
                document.getElementById('lvl-display').innerText = saveData.levelIndex + 1;
                showScreen('screen-menu');
                tg.showPopup({ title: 'LEVEL COMPLETE', message: 'Memory saved.' });
                return;
            }

            const stage = currentLevelData.stages[currentStageIndex];
            
            if(stage.type === 'story') {
                initStory(stage);
            } else if(stage.type === 'game_decrypt') {
                initDecryptGame(stage);
            }
        }

        // --- STORY ENGINE ---
        let storyLines = [];
        let storyLineIdx = 0;

        function initStory(stage) {
            showScreen('screen-story');
            document.getElementById('visual-context').innerText = stage.visual;
            document.getElementById('speaker-name').innerText = stage.speaker + ":";
            storyLines = stage.text;
            storyLineIdx = 0;
            typeText(storyLines[0]);
        }

        function typeText(txt) {
            const el = document.getElementById('story-text');
            el.innerText = "";
            let i = 0;
            const timer = setInterval(() => {
                el.innerText += txt.charAt(i);
                i++;
                if(i >= txt.length) clearInterval(timer);
            }, 30);
        }

        function advanceStory() {
            storyLineIdx++;
            if(storyLineIdx >= storyLines.length) {
                currentStageIndex++;
                loadStage();
            } else {
                typeText(storyLines[storyLineIdx]);
            }
        }

        // --- GAME: SIGNAL DECRYPT LOGIC ---
        let decryptState = { pos: 0, dir: 1, speed: 1, hits: 0, req: 0, active: false };
        let gameLoop;

        function initDecryptGame(stage) {
            showScreen('screen-decrypt');
            decryptState.hits = 0;
            decryptState.req = stage.required;
            decryptState.speed = 1.5 * stage.difficulty;
            decryptState.pos = 0;
            decryptState.active = true;
            
            document.getElementById('decrypt-status').innerText = stage.msg;
            updateProgress(0);
            
            // Randomize Target Zone
            const zone = document.getElementById('target-zone');
            const randomLeft = 20 + Math.random() * 40; // Between 20% and 60%
            zone.style.left = randomLeft + "%";
            zone.style.width = "20%"; // 20% width

            if(gameLoop) clearInterval(gameLoop);
            gameLoop = setInterval(updateDecryptAnim, 16); // 60fps
        }

        function updateDecryptAnim() {
            if(!decryptState.active) return;
            
            // Move Cursor
            decryptState.pos += decryptState.speed * decryptState.dir;
            if(decryptState.pos >= 100 || decryptState.pos <= 0) {
                decryptState.dir *= -1; // Bounce
            }
            
            document.getElementById('cursor-line').style.left = decryptState.pos + "%";
        }

        function checkDecryptHit() {
            if(!decryptState.active) return;

            const cursor = decryptState.pos;
            const zone = document.getElementById('target-zone');
            const zoneLeft = parseFloat(zone.style.left);
            const zoneRight = zoneLeft + parseFloat(zone.style.width);

            if(cursor >= zoneLeft && cursor <= zoneRight) {
                // SUCCESS
                decryptState.hits++;
                tg.HapticFeedback.impactOccurred('medium');
                
                // Visual Feedback
                document.getElementById('decrypt-area').style.borderColor = "#00ff41";
                setTimeout(() => document.getElementById('decrypt-area').style.borderColor = "#333", 200);

                // Move target slightly to make it harder
                zone.style.left = (Math.random() * 80) + "%";

            } else {
                // FAIL
                tg.HapticFeedback.notificationOccurred('error');
                document.getElementById('screen-decrypt').classList.add('shake');
                setTimeout(() => document.getElementById('screen-decrypt').classList.remove('shake'), 400);
                // Penalty (optional): decryptState.hits = Math.max(0, decryptState.hits - 1);
            }

            updateProgress();

            if(decryptState.hits >= decryptState.req) {
                decryptState.active = false;
                clearInterval(gameLoop);
                setTimeout(() => {
                    currentStageIndex++;
                    loadStage();
                }, 500);
            }
        }

        function updateProgress() {
            const pct = (decryptState.hits / decryptState.req) * 100;
            document.getElementById('progress-fill').style.width = pct + "%";
            document.getElementById('decrypt-status').innerText = `SYNC: ${Math.floor(pct)}%`;
        }

    </script>
</body>
</html>
