<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Project Mnemosyne</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- CYBERPUNK THEME --- */
        :root { --bg: #050505; --text: #00ff41; --fail: #ff003c; --ui: #1a1a1a; }
        body { background: var(--bg); color: var(--text); font-family: 'Courier New', monospace; margin: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        /* LAYOUT */
        #crt-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%; pointer-events: none; z-index: 99;
        }
        
        .screen { display: none; height: 100%; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }
        .center { justify-content: center; align-items: center; text-align: center; }

        /* UI ELEMENTS */
        h1 { text-shadow: 0 0 10px var(--text); margin-bottom: 5px; }
        .stat-bar { display: flex; justify-content: space-between; padding: 10px; background: var(--ui); border-bottom: 1px solid var(--text); }
        .dialogue-box { 
            background: rgba(0,20,0,0.9); border: 1px solid var(--text); padding: 15px; 
            margin-top: auto; min-height: 150px; font-size: 16px; line-height: 1.5; 
            box-shadow: 0 0 15px rgba(0,255,65,0.2); cursor: pointer;
        }
        .btn {
            background: transparent; border: 1px solid var(--text); color: var(--text);
            padding: 15px; margin: 10px 0; width: 100%; max-width: 300px;
            font-family: inherit; font-size: 18px; cursor: pointer;
            transition: 0.2s; text-transform: uppercase;
        }
        .btn:hover { background: var(--text); color: black; }
        .btn:disabled { opacity: 0.3; pointer-events: none; }

        /* PUZZLE AREA */
        #game-area { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
        #prompt-display { font-size: 40px; font-weight: bold; margin-bottom: 30px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 350px; }
        .tile { height: 100px; border-radius: 5px; border: 2px solid #333; transition: transform 0.1s; }
        .tile:active { transform: scale(0.95); }

        /* ANIMATIONS */
        @keyframes glitch { 
            0% { transform: translate(0) } 20% { transform: translate(-2px, 2px) } 
            40% { transform: translate(-2px, -2px) } 60% { transform: translate(2px, 2px) } 
            80% { transform: translate(2px, -2px) } 100% { transform: translate(0) }
        }
        .glitch-text { animation: glitch 0.3s infinite; color: var(--fail); }
    </style>
</head>
<body>

    <div id="crt-overlay"></div>

    <div id="screen-menu" class="screen center active">
        <h1>PROJECT MNEMOSYNE</h1>
        <p>SYSTEM STATUS: CRITICAL</p>
        <p>SUBJECT: HUMAN ZERO</p>
        <br>
        <button class="btn" onclick="startGame()">INITIALIZE REPAIR</button>
        <button class="btn" onclick="resetData()">WIPE DATA</button>
    </div>

    <div id="screen-story" class="screen" onclick="advanceStory()">
        <div style="flex:1;"></div> <div class="dialogue-box">
            <b id="speaker-name">SYSTEM:</b><br>
            <span id="story-text">...</span>
            <div style="text-align: right; font-size: 12px; margin-top: 10px;">[TAP TO CONTINUE]</div>
        </div>
    </div>

    <div id="screen-map" class="screen">
        <div class="stat-bar">
            <span>DATA: <span id="ui-data">0</span>%</span>
            <span>DAY: <span id="ui-day">1</span></span>
        </div>
        <h2 style="text-align: center;">MEMORY BANKS</h2>
        <div id="level-list" style="overflow-y: auto; flex: 1;"></div>
    </div>

    <div id="screen-game" class="screen">
        <div class="stat-bar">
            <span>TIMER: <span id="ui-timer">0.0</span>s</span>
            <span>REQ: <span id="ui-req">0</span></span>
        </div>
        <div id="game-area">
            <div id="prompt-display">READY</div>
            <div id="options-container" class="grid-2"></div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- GAME CONTENT (THIS IS WHERE YOU ADD THE 45 MINUTES OF STORY) ---
        // To make it long, add more 'chapters' here.
        const STORY_DATA = [
            {
                id: 1,
                title: "Boot Sequence",
                type: "story",
                speaker: "AI SYSTEM",
                text: ["Connection established.", "Subject Zero's vitals are fading.", "Memory cortex is 90% corrupted.", "I must manually reroute the neural pathways to save them."]
            },
            {
                id: 2,
                title: "Basic Motor Skills",
                type: "puzzle",
                mode: "match", // Simple color match
                speed: 2000,
                rounds: 5,
                reward: 10
            },
            {
                id: 3,
                title: "The First Memory",
                type: "story",
                speaker: "SUBJECT ZERO",
                text: ["Who... who is there?", "It's so cold.", "I remember... a blue sky. But the sky hasn't been blue for years.", "Why am I remembering a lie?"]
            },
            {
                id: 4,
                title: "Cognitive Dissonance",
                type: "puzzle",
                mode: "stroop", // TRICKY: Text says RED, Color is BLUE
                speed: 3000,
                rounds: 8,
                reward: 15
            },
            {
                id: 5,
                title: "System Failure",
                type: "story",
                speaker: "AI SYSTEM",
                text: ["Warning. Subject is rejecting the memory.", "Heart rate increasing.", "The memory of the sky is triggered by trauma.", "Injecting stabilizer..."]
            },
            {
                id: 6,
                title: "Pattern Lock",
                type: "puzzle",
                mode: "sequence", // Simon Says Style
                speed: 1000,
                rounds: 4, // 4 sequences
                reward: 20
            },
            // --- ADD 50 MORE LEVELS HERE TO MAKE IT 45 MINS ---
            {
                id: 7,
                title: "The Truth",
                type: "story",
                speaker: "SUBJECT ZERO",
                text: ["It wasn't a lie.", "The sky was blue because we built the dome.", "But I... I broke the glass.", "I killed them all, didn't I?"]
            }
        ];

        // --- STATE MANAGEMENT ---
        let playerState = {
            currentLevelIndex: 0,
            dataPoints: 0
        };

        // --- ENGINE ---
        function startGame() {
            if(localStorage.getItem('mnemosyne_save')) {
                playerState = JSON.parse(localStorage.getItem('mnemosyne_save'));
            }
            loadLevel(playerState.currentLevelIndex);
        }

        function saveGame() {
            localStorage.setItem('mnemosyne_save', JSON.stringify(playerState));
        }

        function resetData() {
            localStorage.clear();
            location.reload();
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- STORY ENGINE ---
        let currentStoryLines = [];
        let storyLineIndex = 0;

        function loadLevel(index) {
            if (index >= STORY_DATA.length) {
                alert("STORY COMPLETE. THANKS FOR PLAYING.");
                return;
            }
            
            const level = STORY_DATA[index];
            
            if (level.type === 'story') {
                currentStoryLines = level.text;
                storyLineIndex = 0;
                document.getElementById('speaker-name').innerText = level.speaker + ":";
                showScreen('screen-story');
                renderStoryText();
            } else {
                startPuzzle(level);
            }
        }

        function renderStoryText() {
            const txt = currentStoryLines[storyLineIndex];
            const el = document.getElementById('story-text');
            el.innerText = "";
            let i = 0;
            // Typewriter effect
            const typeTimer = setInterval(() => {
                el.innerText += txt.charAt(i);
                i++;
                if(i >= txt.length) clearInterval(typeTimer);
            }, 30);
        }

        function advanceStory() {
            storyLineIndex++;
            if (storyLineIndex >= currentStoryLines.length) {
                playerState.currentLevelIndex++;
                saveGame();
                loadLevel(playerState.currentLevelIndex);
            } else {
                renderStoryText();
            }
        }

        // --- PUZZLE ENGINE ---
        let puzzleState = { score: 0, target: 0, timer: 0, interval: null, levelData: null, sequence: [], userSeq: [] };
        const COLORS = ['#ff003c', '#00ff41', '#00eaff', '#ffe600']; // Cyberpunk colors
        const COLOR_NAMES = ['RED', 'GREEN', 'BLUE', 'YELLOW'];

        function startPuzzle(level) {
            puzzleState.levelData = level;
            puzzleState.score = 0;
            puzzleState.target = level.rounds;
            showScreen('screen-game');
            document.getElementById('ui-req').innerText = level.rounds;
            
            if(level.mode === 'sequence') startSequenceRound();
            else startReflexRound();
        }

        // MODE: REFLEX (Match & Stroop)
        function startReflexRound() {
            if(puzzleState.score >= puzzleState.target) { completeLevel(); return; }

            const container = document.getElementById('options-container');
            container.innerHTML = '';
            const prompt = document.getElementById('prompt-display');
            
            // LOGIC FOR STROOP VS NORMAL
            let targetColor = COLORS[Math.floor(Math.random() * COLORS.length)];
            let isStroop = puzzleState.levelData.mode === 'stroop';
            
            if(isStroop) {
                let wrongNameIndex = Math.floor(Math.random() * COLOR_NAMES.length);
                prompt.innerText = COLOR_NAMES[wrongNameIndex]; // Text says "RED"
                prompt.style.color = targetColor; // But color is GREEN
            } else {
                prompt.innerText = "";
                prompt.style.backgroundColor = targetColor;
                prompt.style.width = "100px";
                prompt.style.height = "100px";
                prompt.style.borderRadius = "50%";
                prompt.style.margin = "0 auto 30px auto";
            }

            // Generate Buttons
            let options = [...COLORS];
            options.sort(() => Math.random() - 0.5);
            
            options.forEach(col => {
                const btn = document.createElement('div');
                btn.className = 'tile';
                btn.style.backgroundColor = col;
                btn.onclick = () => {
                    if(col === targetColor) {
                        puzzleState.score++;
                        document.getElementById('ui-req').innerText = puzzleState.target - puzzleState.score;
                        startReflexRound();
                    } else {
                        tg.HapticFeedback.notificationOccurred('error');
                        gameOver();
                    }
                };
                container.appendChild(btn);
            });
        }

        // MODE: SEQUENCE (Simon Says)
        function startSequenceRound() {
            if(puzzleState.score >= puzzleState.target) { completeLevel(); return; }
            
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            document.getElementById('prompt-display').innerText = "WATCH...";
            document.getElementById('prompt-display').style.background = 'transparent';
            
            // Create static buttons
            COLORS.forEach((col, idx) => {
                const btn = document.createElement('div');
                btn.className = 'tile';
                btn.id = 'seq-btn-'+idx;
                btn.style.backgroundColor = col;
                btn.style.opacity = '0.3';
                btn.onclick = () => checkSequence(idx);
                container.appendChild(btn);
            });

            // Generate Sequence
            let seqLength = 3 + puzzleState.score; // Gets harder
            puzzleState.sequence = [];
            puzzleState.userSeq = [];
            
            for(let i=0; i<seqLength; i++) {
                puzzleState.sequence.push(Math.floor(Math.random() * 4));
            }

            // Play Sequence
            let i = 0;
            let interval = setInterval(() => {
                if(i >= seqLength) {
                    clearInterval(interval);
                    document.getElementById('prompt-display').innerText = "REPEAT";
                    COLORS.forEach((c, x) => document.getElementById('seq-btn-'+x).style.opacity = '1'); // Enable buttons
                    return;
                }
                let id = puzzleState.sequence[i];
                let btn = document.getElementById('seq-btn-'+id);
                btn.style.opacity = '1';
                setTimeout(() => btn.style.opacity = '0.3', 500);
                i++;
            }, 800);
        }

        function checkSequence(btnIndex) {
            puzzleState.userSeq.push(btnIndex);
            // Check if correct so far
            if(puzzleState.userSeq[puzzleState.userSeq.length-1] !== puzzleState.sequence[puzzleState.userSeq.length-1]) {
                gameOver();
                return;
            }
            // Check if done
            if(puzzleState.userSeq.length === puzzleState.sequence.length) {
                puzzleState.score++;
                startSequenceRound();
            }
        }

        function completeLevel() {
            playerState.currentLevelIndex++;
            saveGame();
            tg.showPopup({ title: 'System Stabilized', message: 'Memory restored.' }, () => loadLevel(playerState.currentLevelIndex));
        }

        function gameOver() {
            tg.showPopup({ title: 'CRITICAL FAILURE', message: 'Neural link severed. Try again.' }, () => startPuzzle(puzzleState.levelData));
        }

    </script>
</body>
</html>
